<!DOCTYPE html>
<html>


<head>
    <meta charset="utf-8">
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
    <!-- style sheet -->
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div id="my_chart"></div>

    <div class="flex-container">
        <div class="item1">
            <!-- Create a div where the graph will take place -->
            <p><span><label for="age">Select tranche d'age : </label></span>
                <select id="age">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_age_tranche_1">18...29</option>
                    <option value="nb_Voiture_age_tranche_2">30...59</option>
                    <option value="nb_Voiture_age_tranche_3">60 et plus</option>
                    <option value="nb_Voiture_age_tranche_NA">NA</option>
                </select>

            <p><span><label for="Familiale">Select situation Familiale : </label></span>
                <select id="Familiale">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_situationF_E">En couple</option>
                    <option value="nb_Voiture_situationF_D">Divorcé(e)</option>
                    <option value="nb_Voiture_situationF_S">Célibataire</option>
                    <option value="nb_Voiture_situationF_M">Marié(e)</option>
                    <option value="nb_Voiture_situationF_NA">NA</option>
                </select>

            <p><span><label for="sexe">Select sexe : </label></span>
                <select id="sexe">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_sexe_F">Femme</option>
                    <option value="nb_Voiture_sexe_M">Homme</option>
                    <option value="nb_Voiture_sexe_NA">NA</option>
                </select>
        </div>

        <div class="item2">
            <p><span><label for="nbenfant">Select nombre d'enfant : </label></span>
                <select id="nbenfant">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_nbenfant_0">Pas d'enfants</option>
                    <option value="nb_Voiture_nbenfant_1">Un enfant</option>
                    <option value="nb_Voiture_nbenfant_2">Deux enfants</option>
                    <option value="nb_Voiture_nbenfant_3">Trois enfants</option>
                    <option value="nb_Voiture_nbenfant_4">Quatre enfants</option>
                    <option value="nb_Voiture_nbenfant_NA">NA</option>
                </select>

            <p><span><label for="deuxiemevtr">Select la deuxième voiture : </label></span>
                <select id="deuxiemevtr">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_deuxiemeV_true">Avec</option>
                    <option value="nb_Voiture_deuxiemeV_false">Sans</option>
                    <option value="nb_Voiture_deuxiemeV_NA">NA</option>
                </select>


            <p><span><label for="couleur">Select la couleur de voiture : </label></span>
                <select id="couleur">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_couleur_blanc">Blanc</option>
                    <option value="nb_Voiture_couleur_bleu">Bleu</option>
                    <option value="nb_Voiture_couleur_gris">Gris</option>
                    <option value="nb_Voiture_couleur_noir">Noir</option>
                    <option value="nb_Voiture_couleur_rouge">Rouge</option>
                </select>
        </div>

        <div class="item3">
            <p><span><label for="occasion">Select voiture d'occation : </label></span>
                <select id="occasion">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_occasion_true">Oui</option>
                    <option value="nb_Voiture_occasion_false">Non</option>
                </select>

            <p><span><label for="salaire">Select le salaire : </label></span>
                <select id="salaire">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_salaire_s1">moin de 1000</option>
                    <option value="nb_Voiture_salaire_s2"> 1000...2999 </option>
                    <option value="nb_Voiture_salaire_s3">3000 et plus</option>
                    <option value="nb_Voiture_salaire_NA">NA</option>
                </select>
            <p><span><label for="prix">Select le prix : </label></span>
                <select id="prix">
                    <option value="nb_voiture">none</option>
                    <option value="nb_Voiture_prix_p1">moin de 10 000</option>
                    <option value="nb_Voiture_prix_p2"> 10 000...19 999 </option>
                    <option value="nb_Voiture_prix_p3">20 000...29 999</option>
                    <option value="nb_Voiture_prix_p4">30 000...49 999</option>
                    <option value="nb_Voiture_prix_p5">50 000...59 999</option>
                    <option value="nb_Voiture_prix_p6">60 000 et plus</option>
                </select>
        </div>
        <div class="item4">
            <p><span><label for="y-axis">Selectionnez l'axe y :</label></span>

                <select id="y-value">
                    <option value="RejetsCO2">Rejets CO2</option>
                    <option value="puissance">Puissance</option>
                    <option value="BonusMalus">Bonus et Malus</option>
                    <option value="CoutEnergie">Coût d'Energie</option>
                    
                </select>

            <p><span><label for="x-axis">Selectionnez l'axe x :</label></span>

                <select id="x-value">
                    <option value="nb_voiture">Nombre de voitures</option>
                    <option value="puissance">Puissance</option>
                    <option value="RejetsCO2">Rejets CO2</option>
                    <option value="BonusMalus">Bonus et Malus</option>
                    <option value="CoutEnergie">Coût d'Energie</option>
                    
                </select>

            <p><button class="button" onclick="setGraph()"><span>Valider</span></button>
        </div>
    </div>



    <script>

        drawGraph('nb_voiture', 'RejetsCO2');



        function setGraph() {
            drawGraph($('#x-value').val(), $('#y-value').val());
        }


        function drawGraph(xText, yText) {
            $('svg').remove();
            // set the dimensions and margins of the graph
            const margin = { top: 100, right: 150, bottom: 60, left: 50 },
                width = 1400 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            // append the svg object to the body of the page
            const svg = d3.select("#my_chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            //load data
            d3.csv("data.csv").then(function (data) {


                    // A function that updates the chart
                    function update(selectedGroup) {
                     // Create new data with the selection

                        const dataFilter = data.map(function (d) { return { value: d[selectedGroup], puissance: d.puissance, nb_voiture: d[selectedGroup], marque: d.marque, nom: d.nom, categorie: d.categorie, RejetsCO2: d.RejetsCO2,BonusMalus: d.BonusMalus,nbPortes: d.nbPortes,CoutEnergie: d.CoutEnergie } })

                        xVal = function (d) { return +d[selectedGroup]; }
                        var max = d3.max(data, xVal) + 1
                        console.log(selectedGroup + " xvalue =  " + max)
                        xScale.domain([0, max]); // <-B
                        svg.select("g")
                            .transition()
                            .duration(1000)
                            .call(xAxis);


                        dot
                            .data(dataFilter)
                            .transition()
                            .duration(2000)
                            .attr("cx", d => xScale(+d.value))
                            .attr("r", d => z(+d.value));
                    }

                    // When the button is changed, run the updateChart function
                    d3.select("#age").on("change", function (event, d) {

                        // recover the option that has been chosen
                        let selectedOption = d3.select(this).property("value")
                        // run the updateChart function with this selected option

                        //update($('#age').val())
                        update(selectedOption)
                    })
                    //filters for color, sexe ,nbenfants...
                    d3.select("#Familiale").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    
                    })
                    d3.select("#sexe").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#nbenfant").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#deuxiemevtr").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#couleur").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#occasion").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#salaire").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })
                    d3.select("#prix").on("change", function (event, d) {
                        let selectedOption = d3.select(this).property("value")
                        update(selectedOption)
                    })


                    // setup x 
                    var xValue = function (d) { return d[xText]; }; // data -> value
                    xScale = d3.scaleLinear().range([0, width - 200]); // value -> display
                    xMap = function (d) { return xScale(xValue(d)); }; // data -> display
                    xAxis = d3.axisBottom(xScale);

                    // setup y
                    var yValue = function (d) { return d[yText]; }, // data -> value
                        yScale = d3.scaleLinear().range([height, 0]), // value -> display
                        yMap = function (d) { return yScale(yValue(d)); }, // data -> display
                        yAxis = d3.axisLeft(yScale);

                    // Add a scale for bubble size
                    const z = d3.scaleLinear()
                        .domain([600, 80000])
                        .range([4, 100]);

                    data.forEach(function (d) {
                        d[yText] = +d[yText];
                        d[xText] = +d[xText];

                    });

                    // don't want dots overlapping axis, so add in buffer to data domain
                    xScale.domain([0, d3.max(data, xValue) + 1]);
                    yScale.domain([0, d3.max(data, yValue) + 1]);

                    //console.log(d3.min(data, xValue)-1 )
                    console.log(d3.max(data, xValue) + 1)

                    // x-axis
                    const xAx = svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis)
                        .append("text")
                        .attr("class", "label")
                        .attr("x", width)
                        .attr("y", -6)
                        .style("text-anchor", "end")
                        .text(xText);

                    // y-axis
                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                        .append("text")
                        .attr("class", "label")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text(yText);

                    // Add X axis label:
                    svg.append("text")
                        .attr("text-anchor", "end")
                        .attr("x", 500)
                        .attr("y", height + 40)
                        .text("X axis " + xText);

                    // Y axis label:
                    svg.append("text")
                        .attr("text-anchor", "end")
                        .attr("transform", "rotate(-90)")
                        .attr("y", -margin.left + 10)
                        .attr("x", -margin.top + 5)
                        .text("Y axis " + yText)


                    //add title to the graph
                    svg.append("text")
                        .attr("x", (width / 2))
                        .attr("y", 0 - (margin.top / 2))
                        .attr("text-anchor", "middle")
                        .style("font-size", "16px")
                        .style("text-decoration", "underline")
                        .style("font-size", "40px")
                        .style("font-weight", "bold")
                        .text(xText + " VS  " + yText);

                    // Add a scale for bubble color
                    const myColor = d3.scaleOrdinal()
                        .domain(["Citadine", "Compacte", "Familiale", "BerlineOuRoutiere", "Sportive"])
                        .range(d3.schemeSet2);

                    // -1- Create a tooltip div that is hidden by default:
                    const tooltip = d3.select("#my_chart")
                        .append("div")
                        .style("opacity", 0)
                        .attr("class", "tooltip")
                        .style("background-color", "black")
                        .style("border-radius", "5px")
                        .style("padding", "10px")
                        .style("color", "white")
                        .style("position", "absolute")
                        

                    // -2- Create 3 functions to show / update (when mouse move but stay on same circle) / hide the tooltip
                    const showTooltip = function (event, d) {
                        //console.log("here is d " + d)
                        tooltip
                            .transition()
                            .duration(200)
                        tooltip
                            .style("opacity", 0.5)
                            .html(" Puissance: " + d.puissance + "<br>" +
                                "Nb_voiture_vendu: " + d.nb_voiture + "<br>" +
                                "Categorie: " + d.categorie + "<br>" +
                                "Marque : " + d.marque + " " + d.nom "<br>" +
                                "RejetsCO2 : " + d.RejetsCO2 + "<br>"+
                                "BonusMalus : " + d.BonusMalus + "<br>"+
                                "nbPortes : " + d.nbPortes + "<br>"+
                                 "CoutEnergie : " + d.CoutEnergie 

                            )
                            .style("left", (event.x) / 2 + "px")
                           .style("top", (event.y) / 2 + 30 + "px")
                    }
                    const moveTooltip = function (event, d) {
                        tooltip
                            .style("left", (event.x) / 2 + "px")
                            .style("top", (event.y) / 2 + 30 + "px")
                    }
                    const hideTooltip = function (event, d) {
                        tooltip
                            .transition()
                            .duration(200)
                            .style("opacity", 0)
                    }

                    // ---------------------------//
                    //       HIGHLIGHT GROUP      //
                    // ---------------------------//

                    // What to do when one group is hovered
                    const highlight = function (event, d) {
                        console.log(".bubbles." + d)
                        // reduce opacity of all groups
                        d3.selectAll(".bubbles").style("opacity", .01)
                        // expect the one that is hovered

                        d3.selectAll("." + d).style("opacity", 1)
                    }

                    // And when it is not hovered anymore
                    const noHighlight = function (event, d) {
                        d3.selectAll(".bubbles").style("opacity", 1)
                    }
                    // ---------------------------//
                    //       CIRCLES              //
                    // ---------------------------//


                    // Add dots
                    const dot = svg.append('g')
                        .selectAll("dot")
                        .data(data)
                        .join("circle")
                        .attr("class", function (d) { return "bubbles " + d.categorie })
                        .attr("cx", xMap)
                        .attr("cy", yMap)
                        .attr("r", d => z(d.nb_voiture))
                        .style("fill", d => myColor(d.categorie))

                    // -3- Trigger the functions
                        .on("mouseover", showTooltip)
                        .on("mousemove", moveTooltip)
                        .on("mouseleave", hideTooltip)

                    // ---------------------------//
                    //       LEGEND              //
                    // ---------------------------//

                    // Add legend: circles
                    const valuesToShow = [8000, 16000, 26000]
                    const xCircle = 1200
                    const xLabel = 1250
                    svg
                        .selectAll("legend")
                        .data(valuesToShow)
                        .join("circle")
                        .attr("cx", xCircle)
                        .attr("cy", d => height - 100 - z(d))
                        .attr("r", d => z(d))
                        .style("fill", "none")
                        .attr("stroke", "black")

                    // Add legend: segments
                    svg
                        .selectAll("legend")
                        .data(valuesToShow)
                        .join("line")
                        .attr('x1', d => xCircle + z(d))
                        .attr('x2', xLabel)
                        .attr('y1', d => height - 100 - z(d))
                        .attr('y2', d => height - 100 - z(d))
                        .attr('stroke', 'black')
                        .style('stroke-dasharray', ('2,2'))

                    // Add legend: labels
                    svg
                        .selectAll("legend")
                        .data(valuesToShow)
                        .join("text")
                        .attr('x', xLabel)
                        .attr('y', d => height - 100 - z(d))
                        .text(d => d / 1000000)
                        .style("font-size", 10)
                        .attr('alignment-baseline', 'middle')

                    // Legend title
                    svg.append("text")
                        .attr('x', xCircle)
                        .attr("y", height - 100 + 30)
                        .text("Nombre de voiture vendues")
                        .attr("text-anchor", "middle")

                    // Add one dot in the legend for each name.
                    const size = 20
                    const allgroups = ["Citadine", "Compacte", "Familiale", "BerlineOuRoutiere", "Sportive"]
                    svg.selectAll("myrect")
                        .data(allgroups)
                        .join("circle")
                        .attr("cx", 1200)
                        .attr("cy", (d, i) => 10 + i * (size + 5)) // 100 is where the first dot appears. 25 is the distance between dots
                        .attr("r", 7)
                        .style("fill", d => myColor(d))
                        .on("mouseover", highlight)
                        .on("mouseleave", noHighlight)

                    // Add labels beside legend dots
                    svg.selectAll("mylabels")
                        .data(allgroups)
                        .enter()
                        .append("text")
                        .attr("x", 1200 + size * .8)
                        .attr("y", (d, i) => i * (size + 5) + (size / 2)) // 100 is where the first dot appears. 25 is the distance between dots
                        .style("fill", d => myColor(d))
                        .text(d => d)
                        .attr("text-anchor", "left")
                        .style("alignment-baseline", "middle")
                        .on("mouseover", highlight)
                        .on("mouseleave", noHighlight)




                })

        }
    </script>
</body>

</html>
